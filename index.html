<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå¸‚å½ˆç å° V5 (æ…¢é€Ÿæ“¬çœŸç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --wood-primary: #8b5a2b;
            --wood-dark: #5c3a1b;
            --neon-pink: #ff00de;
            --neon-blue: #00f7ff;
        }

        body {
            background-color: #121212;
            color: white;
            font-family: 'Microsoft JhengHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        h1 {
            color: var(--neon-pink);
            text-shadow: 0 0 10px var(--neon-pink);
            margin-bottom: 10px;
            font-style: italic;
        }

        /* æ©Ÿå°å¤–æ®¼ */
        .machine-container {
            position: relative;
            width: 100%;
            max-width: 420px;
            background: linear-gradient(180deg, #462810 0%, #2a1608 100%);
            border-radius: 30px 30px 10px 10px;
            border: 4px solid #8b5a2b;
            box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.8);
            padding: 20px;
            box-sizing: border-box;
        }

        /* è³‡è¨Šé¢æ¿ */
        .info-panel {
            background: #000;
            border: 2px solid #555;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #00f7ff;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* éŠæˆ²å€åŸŸ (Canvas + DOM) */
        .game-board {
            position: relative;
            height: 420px; /* ç¨å¾®åŠ é«˜ä¸€é»è®“å®ƒæ»¾ä¹…ä¸€é» */
            background-color: #3e2723; 
            background-image: radial-gradient(#5d4037 15%, transparent 16%);
            background-size: 20px 20px; 
            border-radius: 15px;
            border: 2px solid #1a1008;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
        }

        /* é‡˜å­ (è¦–è¦ºè£é£¾) */
        .pins-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }
        .pin {
            position: absolute;
            width: 6px; height: 6px;
            background: #aaa;
            border-radius: 50%;
            box-shadow: 1px 1px 2px black;
        }

        /* åº•éƒ¨æ´å£ */
        .slots-container {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .slot {
            width: 18px;
            height: 25px;
            background: #222;
            border: 2px solid #555;
            border-radius: 0 0 10px 10px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            font-size: 10px;
            color: #888;
            transition: 0.2s;
        }
        
        .slot::before {
            content: '';
            position: absolute;
            top: -15px;
            width: 10px; height: 10px;
            background: #333;
            border-radius: 50%;
            border: 1px solid #111;
            transition: 0.2s;
        }

        /* äº®ç‡ˆæ¨£å¼ */
        .slot.lit { border-color: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .slot.lit::before { background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .slot.hard.lit { border-color: #ffaa00; box-shadow: 0 0 10px #ffaa00; }
        .slot.hard.lit::before { background: #ffaa00; box-shadow: 0 0 10px #ffaa00; }

        /* è½çƒé€²æ´ */
        .slot.landed { background: var(--neon-pink); }

        /* å½ˆç  */
        #ball {
            position: absolute;
            width: 14px; height: 14px;
            background: radial-gradient(circle at 30% 30%, #fff, #999, #333);
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            display: none; 
            z-index: 10;
        }

        /* æ§åˆ¶å€ */
        .controls {
            margin-top: 15px;
            background: #2a1608;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #5c3a1b;
        }

        button {
            width: 100%; padding: 12px; margin-bottom: 10px;
            border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;
            cursor: pointer; text-transform: uppercase; transition: 0.1s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { filter: grayscale(1); cursor: not-allowed; opacity: 0.6; }

        #randomBtn { background: #e91e63; color: white; }
        #playBtn { background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; box-shadow: 0 4px 0 #004a9e; }
        #playBtn:active { box-shadow: 0 0 0; transform: translateY(4px); }

        .input-group {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px;
        }
        input {
            background: transparent; border: none; color: white; font-size: 1.2rem;
            text-align: center; width: 60px; font-weight: bold;
        }
        input:focus { outline: none; }

        /* å½ˆçª— */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box {
            background: #222; padding: 30px; border-radius: 15px;
            text-align: center; border: 2px solid var(--neon-pink);
            box-shadow: 0 0 30px var(--neon-pink);
            animation: popUp 0.3s;
        }
        @keyframes popUp { from{transform:scale(0.5);} to{transform:scale(1);} }
    </style>
</head>
<body>

<h1>å¤œå¸‚å½ˆç å° <span style="font-size:0.5em; color:#fff;">V5</span></h1>

<div class="machine-container">
    
    <div class="info-panel">
        <div>å€ç‡: <span id="current-multi" style="color:var(--neon-pink)">--</span></div>
        <div>çæ± : <span id="poolAmount">--</span></div>
    </div>

    <div class="game-board" id="gameBoard">
        <div class="pins-overlay" id="pinsContainer"></div>
        <div id="ball"></div>
        <div class="slots-container" id="slotsContainer"></div>
    </div>

    <div style="text-align:center; font-size:0.8em; color:#888; margin-top:5px;" id="statusText">è«‹å…ˆé€£æ¥éŒ¢åŒ…</div>

    <div class="controls">
        <button id="connectBtn" onclick="connectWallet()">ğŸ”— é€£æ¥éŒ¢åŒ…</button>
        <button id="randomBtn" onclick="randomizeConfig()" disabled>ğŸ° æŠ•å¹£é¸å° (éš¨æ©Ÿé…ç½®)</button>
        <div class="input-group">
            <span style="color:#aaa; margin-right:5px;">ä¸‹æ³¨:</span>
            <input type="number" id="betAmount" value="1">
            <span style="color:var(--neon-blue);">CRO</span>
        </div>
        <button id="playBtn" onclick="playGame()" disabled>ğŸ”´ æ‹‰æ¡¿ç™¼å°„ (PLAY)</button>
    </div>
</div>

<div class="modal-overlay" id="resultModal">
    <div class="modal-box">
        <h2 id="modalTitle">ä¸­çï¼</h2>
        <div id="modalValue" style="font-size:2em; margin:15px 0; color:#0f0;">+10 CRO</div>
        <button onclick="closeModal()" style="background:#333; color:white; width:auto; padding:10px 30px;">ç¢ºå®š</button>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = "0xF7A250Da8B321ce557d0fF415BA93894650A5E12";
    const ABI = [
        "function play(uint256 chosenMultiplier) external payable",
        "function getBankrollBalance() external view returns (uint256)",
        "event BallShot(address indexed player, uint256 betAmount, uint256 multiplier, uint256 payout)"
    ];

    const TOTAL_SLOTS = 15;
    const HARD_INDICES = [0, 4, 5, 9, 10, 14]; 
    const CONFIGS = [
        { multi: 2, lights: 4 },
        { multi: 4, lights: 3 },
        { multi: 6, lights: 2 },
        { multi: 8, lights: 2, hard: true },
        { multi: 10, lights: 1 }
    ];

    let provider, signer, contract;
    let currentMultiplier = 0;
    let activeSlots = [];
    let userAddress = "";

    function init() {
        const slotsDiv = document.getElementById("slotsContainer");
        const pinsDiv = document.getElementById("pinsContainer");

        for (let i = 0; i < TOTAL_SLOTS; i++) {
            let slot = document.createElement("div");
            slot.className = "slot";
            slot.id = "slot-" + i;
            if (HARD_INDICES.includes(i)) slot.dataset.hard = "true";
            slotsDiv.appendChild(slot);
        }

        for (let row = 0; row < 9; row++) {
            let count = 6 + (row % 2); 
            for (let col = 0; col < count; col++) {
                let pin = document.createElement("div");
                pin.className = "pin";
                let top = 40 + row * 35;
                let left = 20 + col * (380 / count) + (row % 2 * 15);
                pin.style.top = top + "px";
                pin.style.left = left + "px";
                pinsDiv.appendChild(pin);
            }
        }
    }
    init();

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById("connectBtn").style.display = "none";
            document.getElementById("statusText").innerText = "å·²é€£æ¥: " + userAddress.substring(0,6) + "...";
            document.getElementById("randomBtn").disabled = false;
            document.getElementById("playBtn").disabled = false;

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            updatePool();
            randomizeConfig(); 

        } catch (e) { alert("é€£æ¥å¤±æ•—"); }
    }

    async function updatePool() {
        if(!contract) return;
        try {
            const bal = await contract.getBankrollBalance();
            document.getElementById("poolAmount").innerText = parseFloat(ethers.formatEther(bal)).toFixed(2) + " CRO";
        } catch(e){}
    }

    function randomizeConfig() {
        document.querySelectorAll(".slot").forEach(s => {
            s.classList.remove("lit", "hard", "landed");
        });

        const conf = CONFIGS[Math.floor(Math.random() * CONFIGS.length)];
        currentMultiplier = conf.multi;
        document.getElementById("current-multi").innerText = conf.multi + "X";

        let candidates = Array.from({length: TOTAL_SLOTS}, (_, i) => i);
        if (conf.hard) {
            candidates = candidates.filter(i => HARD_INDICES.includes(i));
        }
        
        activeSlots = candidates.sort(()=>0.5-Math.random()).slice(0, conf.lights);

        activeSlots.forEach(idx => {
            let el = document.getElementById("slot-" + idx);
            el.classList.add("lit");
            if(conf.hard) el.classList.add("hard");
        });
    }

    async function playGame() {
        if (currentMultiplier === 0) return alert("è«‹å…ˆé¸å°");
        const amt = document.getElementById("betAmount").value;
        
        const playBtn = document.getElementById("playBtn");
        const rndBtn = document.getElementById("randomBtn");
        playBtn.disabled = true;
        rndBtn.disabled = true;
        playBtn.innerText = "ç­‰å¾…ç¢ºèª...";

        try {
            const tx = await contract.play(currentMultiplier, { value: ethers.parseEther(amt) });
            playBtn.innerText = "å½ˆç æº–å‚™ç™¼å°„...";
            const receipt = await tx.wait();
            
            let wonMultiplier = 0;
            let payout = 0;
            for (const log of receipt.logs) {
                try {
                    const parsed = contract.interface.parseLog(log);
                    if (parsed.name === "BallShot" && parsed.args.player === userAddress) {
                        wonMultiplier = Number(parsed.args.multiplier);
                        payout = ethers.formatEther(parsed.args.payout);
                    }
                } catch(e){}
            }
            startPhysicsAnimation(wonMultiplier, payout);

        } catch (e) {
            console.error(e);
            alert("äº¤æ˜“å–æ¶ˆæˆ–å¤±æ•—");
            resetUI();
        }
    }

    // ğŸ”¥ğŸ”¥ğŸ”¥ V5 ç‰©ç†å¼•æ“æ ¸å¿ƒä¿®æ”¹ ğŸ”¥ğŸ”¥ğŸ”¥
    function startPhysicsAnimation(multiplier, payout) {
        const ball = document.getElementById("ball");
        ball.style.display = "block";
        ball.style.top = "0px";
        
        let targetIndex;
        if (multiplier > 0) {
            targetIndex = activeSlots[Math.floor(Math.random() * activeSlots.length)];
        } else {
            let all = Array.from({length: TOTAL_SLOTS}, (_, i) => i);
            let empty = all.filter(i => !activeSlots.includes(i));
            targetIndex = empty[Math.floor(Math.random() * empty.length)];
        }

        const targetPercent = (targetIndex + 0.5) * (100 / TOTAL_SLOTS);

        // --- V5 åƒæ•¸èª¿æ ¡ ---
        let y = 0;
        let x = 50;
        let vy = 0;
        // å¢åŠ åˆå§‹æ°´å¹³é€Ÿåº¦çš„éš¨æ©Ÿæ€§
        let vx = (Math.random() - 0.5) * 6; 
        
        // ğŸ”¥ é‡åŠ›å¤§å¹…é™ä½ (0.5 -> 0.2)ï¼Œè®“ä¸‹è½è®Šæ…¢
        const gravity = 0.2; 
        const floorY = 390;

        const interval = setInterval(() => {
            vy += gravity;
            y += vy;
            x += vx;

            // ğŸ”¥ æ“´å¤§ç¢°æ’å€åŸŸä¸¦æé«˜ç¢°æ’æ©Ÿç‡ï¼Œå¢åŠ éš¨æ©Ÿå½ˆè·³æ„Ÿ
            if (y > 30 && y < 330 && Math.random() < 0.25) {
                vy *= 0.7; // ç¢°æ’å¾Œå‚ç›´é€Ÿåº¦è¡°æ¸›ï¼Œå¢åŠ æ»¯ç•™æ„Ÿ
                vx = (Math.random() - 0.5) * 5; // éš¨æ©Ÿæ°´å¹³å½ˆå°„
            }

            if (x < 2 || x > 98) vx *= -1;

            // ğŸ”¥ é—œéµä¿®æ”¹ï¼šå»¶å¾Œä¸¦æ¸›å¼±ä½œå¼Šå°èˆª
            // ç›´åˆ°æœ€å¾Œå¿«é€²æ´äº† (y > 330) æ‰é–‹å§‹å¾®èª¿ï¼Œä¸”åŠ›é“æ¸›å¼±
            if (y > 330) {
                let dx = targetPercent - x;
                vx += dx * 0.025; // å°å‘åŠ›æ¸›å¼±ï¼Œé¿å…ç”Ÿç¡¬æ‹‰æ‰¯
                vx *= 0.92; // å¢åŠ é˜»åŠ›è®“æœ€å¾Œæ»‘è¡Œè‡ªç„¶
            }

            ball.style.top = y + "px";
            ball.style.left = x + "%";

            if (y >= floorY) {
                clearInterval(interval);
                ball.style.top = floorY + "px";
                finishGame(targetIndex, multiplier, payout);
            }
        }, 20);
    }

    function finishGame(slotIndex, multiplier, payout) {
        const slot = document.getElementById("slot-" + slotIndex);
        slot.classList.add("landed");
        
        setTimeout(() => {
            const modal = document.getElementById("resultModal");
            const title = document.getElementById("modalTitle");
            const val = document.getElementById("modalValue");
            
            modal.style.display = "flex";
            if (multiplier > 0) {
                title.innerText = "ğŸ‰ æ­å–œä¸­çï¼";
                title.style.color = "#4ade80";
                val.innerText = `+${payout} CRO`;
            } else {
                title.innerText = "ğŸ˜¢ æ²’ä¸­...";
                title.style.color = "#aaa";
                val.innerText = "å†æ¥å†å²";
            }
            
            updatePool();
            resetUI();
        }, 500);
    }

    function closeModal() {
        document.getElementById("resultModal").style.display = "none";
        document.getElementById("ball").style.display = "none";
        document.querySelectorAll(".slot").forEach(s => s.classList.remove("landed"));
    }

    function resetUI() {
        document.getElementById("playBtn").disabled = false;
        document.getElementById("randomBtn").disabled = false;
        document.getElementById("playBtn").innerText = "ğŸ”´ æ‹‰æ¡¿ç™¼å°„ (PLAY)";
    }
</script>

</body>
</html>


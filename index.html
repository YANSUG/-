<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå¸‚å½ˆç å° V7 (å¸•é’å“¥ç‰©ç†ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body {
            background-color: #0f0f13;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        h1 {
            color: #ff00de;
            text-shadow: 0 0 10px #ff00de;
            margin-bottom: 10px;
            font-style: italic;
        }

        .container {
            position: relative;
            background: #1a1a24;
            padding: 15px;
            border-radius: 20px;
            border: 2px solid #2d2d3d;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            background: #0b0b13;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #333;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 1.1em;
        }

        /* éŠæˆ²ç•«å¸ƒ - æ‹‰é«˜é«˜åº¦ */
        canvas {
            background: #201c2b;
            border-radius: 12px;
            border: 2px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            margin-bottom: 15px;
            /* èƒŒæ™¯ç¶²æ ¼è£é£¾ */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }

        .btn-connect { background: #3b82f6; color: white; }
        .btn-random { background: #ec4899; color: white; }
        .btn-play { background: linear-gradient(90deg, #00f260, #0575e6); color: white; }

        .input-group {
            display: flex;
            background: #333;
            border-radius: 8px;
            padding: 5px;
            align-items: center;
            justify-content: center;
        }
        input {
            background: transparent; border: none; color: white;
            font-size: 1.2em; text-align: center; width: 80px; font-weight: bold;
        }
        input:focus { outline: none; }

        /* çµæœå½ˆçª— */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: #1f1f2e; padding: 30px; border-radius: 15px;
            text-align: center; border: 2px solid #00f260;
            box-shadow: 0 0 30px rgba(0, 242, 96, 0.3);
            transform: scale(0.8); animation: pop 0.3s forwards;
        }
        @keyframes pop { to { transform: scale(1); } }
    </style>
</head>
<body>

<h1>å¤œå¸‚å½ˆç å° <span style="font-size:0.5em; color:#888;">V7</span></h1>

<div class="container">
    <div class="info-bar">
        <span id="current-multi" style="color:#ec4899">å€ç‡: --</span>
        <span id="poolAmount" style="color:#00f260">çæ± : --</span>
    </div>

    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <div style="font-size:0.8em; color:#666; margin-bottom:10px;" id="statusText">è«‹å…ˆé€£æ¥éŒ¢åŒ…</div>

    <div class="controls">
        <button class="btn btn-connect" id="connectBtn" onclick="connectWallet()">é€£æ¥éŒ¢åŒ…</button>
        <button class="btn btn-random" id="randomBtn" onclick="randomizeConfig()" disabled>ğŸ° æŠ•å¹£é¸å° (éš¨æ©Ÿ)</button>
        
        <div class="input-group">
            <span style="color:#aaa; margin-right:10px;">ä¸‹æ³¨:</span>
            <input type="number" id="betAmount" value="1">
            <span style="color:#00f260;">CRO</span>
        </div>

        <button class="btn btn-play" id="playBtn" onclick="playGame()" disabled>ğŸ”´ ç™¼å°„å½ˆç </button>
    </div>
</div>

<div class="modal" id="resultModal">
    <div class="modal-content">
        <h2 id="resTitle">ä¸­ç!</h2>
        <div id="resVal" style="font-size:2em; color:#00f260; margin:15px 0;">+10 CRO</div>
        <button class="btn" style="background:#444; color:white;" onclick="closeModal()">ç¢ºå®š</button>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = "0xF7A250Da8B321ce557d0fF415BA93894650A5E12";
    const ABI = [
        "function play(uint256 chosenMultiplier) external payable",
        "function getBankrollBalance() external view returns (uint256)",
        "event BallShot(address indexed player, uint256 betAmount, uint256 multiplier, uint256 payout)"
    ];

    const CONFIGS = [
        { multi: 2, lights: 4 },
        { multi: 4, lights: 3 },
        { multi: 6, lights: 2 },
        { multi: 8, lights: 2 },
        { multi: 10, lights: 1 }
    ];
    
    // 10æ ¼é…ç½®
    const NUM_SLOTS = 10;
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    // --- V7 ç‰©ç†åƒæ•¸ (æ…¢é€Ÿæ“¬çœŸ) ---
    const GRAVITY = 0.12;       // é‡åŠ› (å¾ˆè¼•ï¼Œåƒç¾½æ¯›çƒ)
    const BOUNCE = 0.4;         // å½ˆæ€§ (ä½å½ˆæ€§ï¼Œæ’åˆ°æœƒå¸èƒ½ï¼Œä¸æœƒå¾€ä¸Šé£›)
    const FRICTION = 0.98;      // ç©ºæ°£é˜»åŠ›
    const PIN_RADIUS = 3;
    const BALL_RADIUS = 6;
    const MAX_SPEED = 6;        // é™é€Ÿ (é˜²æ­¢ç©¿ç‰†æˆ–é£›å¤©)

    let ball = { x: 0, y: 0, vx: 0, vy: 0, active: false };
    let pins = [];
    let slots = [];
    let activeSlotIndices = [];
    let targetSlotIndex = -1;

    // åˆå§‹åŒ–å ´æ™¯ (å¸•é’å“¥é¢¨æ ¼)
    function initPhysics() {
        pins = [];
        // å¢åŠ åˆ° 12 æ’é‡˜å­ï¼Œå‰µé€ æ¼«é•·çš„è½ä¸‹éç¨‹
        const rows = 12; 
        const startY = 80;
        const spacingY = 35; // å‚ç›´é–“è·

        for (let r = 0; r < rows; r++) {
            // æ¯æ’é‡˜å­æ•¸é‡äº¤éŒ¯ (8å€‹ æˆ– 9å€‹)
            // é€™æ¨£çƒè½ä¸‹æ™‚ä¸€å®šæœƒæ’åˆ°ä¸‹ä¸€æ’çš„ä¸­é–“ (Galton Board åŸç†)
            const pinsInRow = (r % 2 === 0) ? 9 : 10;
            const spacingX = width / (pinsInRow + 1);

            for (let c = 1; c <= pinsInRow; c++) {
                const x = c * spacingX;
                const y = startY + r * spacingY;
                // åŠ å…¥ä¸€é»é»éš¨æ©Ÿæ“¾å‹•ï¼Œè®“æ’åˆ—ä¸é‚£éº¼æ­»æ¿
                const jitter = (Math.random() - 0.5) * 4; 
                pins.push({ x: x + jitter, y: y });
            }
        }

        // åº•éƒ¨æ´å£
        const slotWidth = width / NUM_SLOTS;
        slots = [];
        for(let i=0; i<NUM_SLOTS; i++) {
            slots.push({
                x: i * slotWidth,
                w: slotWidth,
                cx: i * slotWidth + slotWidth / 2,
                lit: false
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);

        // 1. ç•«é‡˜å­
        ctx.fillStyle = '#eee';
        pins.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, PIN_RADIUS, 0, Math.PI * 2);
            ctx.fill();
        });

        // 2. ç•«æ´å£
        for(let i=0; i<NUM_SLOTS; i++) {
            const s = slots[i];
            
            // äº®ç‡ˆåˆ¤å®š
            const isLit = activeSlotIndices.includes(i);
            
            // ç¹ªè£½æ´å£
            ctx.fillStyle = '#1a1a24';
            ctx.fillRect(s.x + 2, height - 40, s.w - 4, 40);
            
            // ç‡ˆè™Ÿ
            if(isLit) {
                // éœ“è™¹å…‰æšˆ
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00f7ff';
                ctx.fillStyle = '#00f7ff';
                ctx.beginPath();
                ctx.arc(s.cx, height - 25, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            } else {
                // ç†„æ»…ç‹€æ…‹
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(s.cx, height - 25, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // åˆ†éš”ç·š
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(s.x, height - 40);
            ctx.lineTo(s.x, height);
            ctx.stroke();
        }

        // 3. ç•«çƒ & ç‰©ç†
        if (ball.active) {
            updatePhysics();
            
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ff00de';
            ctx.fillStyle = '#ff00de';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            
            // é«˜å…‰
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(ball.x - 2, ball.y - 2, 2, 0, Math.PI * 2);
            ctx.fill();
        }

        requestAnimationFrame(draw);
    }

    // ğŸ”¥ V7 ç‰©ç†æ ¸å¿ƒ (ä¿®å¾©é£›å¤©ã€å¢åŠ å¾®é¢¨)
    function updatePhysics() {
        // 1. é‡åŠ›èˆ‡é˜»åŠ›
        ball.vy += GRAVITY;
        ball.vx *= FRICTION;
        ball.vy *= FRICTION;

        // 2. é€Ÿåº¦é™åˆ¶ (é˜²é£›å¤©)
        const speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
        if (speed > MAX_SPEED) {
            const ratio = MAX_SPEED / speed;
            ball.vx *= ratio;
            ball.vy *= ratio;
        }

        // 3. ç§»å‹•
        ball.x += ball.vx;
        ball.y += ball.vy;

        // 4. ç‰†å£åå½ˆ
        if (ball.x < BALL_RADIUS) { ball.x = BALL_RADIUS; ball.vx *= -0.6; }
        if (ball.x > width - BALL_RADIUS) { ball.x = width - BALL_RADIUS; ball.vx *= -0.6; }

        // 5. é‡˜å­ç¢°æ’ (é‡é»å„ªåŒ–)
        for (let p of pins) {
            // ç°¡å–®çš„åœ“å½¢ç¢°æ’æª¢æ¸¬
            const dx = ball.x - p.x;
            const dy = ball.y - p.y;
            const distSq = dx*dx + dy*dy;
            const minDist = BALL_RADIUS + PIN_RADIUS;

            if (distSq < minDist * minDist) {
                // ç™¼ç”Ÿç¢°æ’ï¼
                const angle = Math.atan2(dy, dx);
                
                // å¼·åˆ¶æŠŠçƒæ¨åˆ°é‡˜å­å¤–é¢ (é¿å…é»ä½æˆ–ç©¿è¶Š)
                const pushOut = 1.0; 
                ball.x = p.x + Math.cos(angle) * (minDist + pushOut);
                ball.y = p.y + Math.sin(angle) * (minDist + pushOut);

                // è¨ˆç®—æ–°çš„é€Ÿåº¦ (åå°„)
                // åŠ å…¥ä¸€é»éš¨æ©Ÿæ€§ï¼Œæ¨¡æ“¬ä¸è¦å‰‡è¡¨é¢
                const noise = (Math.random() - 0.5) * 0.5;
                
                // æ’æ“Šå¾Œç²å¾—ä¸€å€‹å‘å¤–çš„æ¨åŠ›ï¼Œä½†æœƒæå¤±å¤§é‡ Y è»¸å‹•èƒ½
                ball.vx += Math.cos(angle + noise) * 1.5; 
                ball.vy = Math.abs(ball.vy) * -BOUNCE; // å¼·åˆ¶åè½‰ Y ä¸¦è¡°æ¸› (ä¸æœƒå¾€ä¸Šé£›å¤ªé«˜)
            }
        }

        // 6. å¾®é¢¨å°èˆª (Invisible Wind)
        // é€™æ˜¯æœ€è‡ªç„¶çš„ä½œå¼Šæ–¹å¼ï¼šä¸æ˜¯ç¡¬æ‹‰ï¼Œè€Œæ˜¯æŒçºŒå¹å¾®é¢¨
        if (targetSlotIndex !== -1 && ball.y < height - 50) {
            const targetX = slots[targetSlotIndex].cx;
            const dist = targetX - ball.x;
            
            // é¢¨åŠ›éš¨è‘—çƒä¸‹é™è€Œç¨å¾®å¢å¼·
            // åœ¨ä¸ŠåŠéƒ¨å¹¾ä¹æ²’æœ‰é¢¨ï¼Œä¸‹åŠéƒ¨é¢¨ç¨å¾®å¤§ä¸€é»é»
            const windStrength = 0.005 + (ball.y / height) * 0.015;
            
            ball.vx += dist * windStrength;
        }

        // 7. é€²æ´åˆ¤å®š
        if (ball.y > height - BALL_RADIUS) {
            ball.active = false;
            // è¦–è¦ºä¿®æ­£ï¼šè®“çƒåœåœ¨æ´å£æ­£ä¸­å¤®
            ball.x = slots[targetSlotIndex].cx;
            ball.y = height - 25;
            setTimeout(showResult, 300);
        }
    }

    // --- Web3 èˆ‡éŠæˆ²é‚è¼¯ ---
    let provider, signer, contract, userAddress;
    let currentConfig = null;
    let pendingResult = null;

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            document.getElementById("connectBtn").style.display = "none";
            document.getElementById("statusText").innerText = "å·²é€£æ¥: " + userAddress.substring(0,6) + "...";
            document.getElementById("randomBtn").disabled = false;
            document.getElementById("playBtn").disabled = false;

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            updatePool();
            randomizeConfig();
            
            initPhysics();
            draw();

        } catch (e) { alert("é€£æ¥å¤±æ•—"); }
    }

    async function updatePool() {
        if(!contract) return;
        try {
            const bal = await contract.getBankrollBalance();
            document.getElementById("poolAmount").innerText = "çæ± : " + parseFloat(ethers.formatEther(bal)).toFixed(2);
        } catch(e){}
    }

    function randomizeConfig() {
        activeSlotIndices = [];
        const conf = CONFIGS[Math.floor(Math.random() * CONFIGS.length)];
        currentConfig = conf;
        document.getElementById("current-multi").innerText = "å€ç‡: " + conf.multi + "X";

        let all = Array.from({length: NUM_SLOTS}, (_, i) => i);
        activeSlotIndices = all.sort(() => 0.5 - Math.random()).slice(0, conf.lights);
    }

    async function playGame() {
        if (!currentConfig) return alert("è«‹å…ˆé¸å°");
        const amt = document.getElementById("betAmount").value;
        const playBtn = document.getElementById("playBtn");
        
        playBtn.disabled = true;
        playBtn.innerText = "ç¢ºèªäº¤æ˜“ä¸­...";

        try {
            const tx = await contract.play(currentConfig.multi, { value: ethers.parseEther(amt) });
            playBtn.innerText = "ç­‰å¾…çµæœ...";
            
            const receipt = await tx.wait();
            
            let wonMultiplier = 0;
            let payout = 0;
            for (const log of receipt.logs) {
                try {
                    const parsed = contract.interface.parseLog(log);
                    if (parsed.name === "BallShot" && parsed.args.player === userAddress) {
                        wonMultiplier = Number(parsed.args.multiplier);
                        payout = ethers.formatEther(parsed.args.payout);
                    }
                } catch(e){}
            }

            playBtn.innerText = "çƒæ»¾å‹•ä¸­...";
            startBallDrop(wonMultiplier, payout);

        } catch (e) {
            console.error(e);
            alert("äº¤æ˜“å–æ¶ˆ");
            playBtn.disabled = false;
            playBtn.innerText = "ğŸ”´ ç™¼å°„å½ˆç ";
        }
    }

    function startBallDrop(multiplier, payout) {
        pendingResult = { payout, win: multiplier > 0 };
        
        // æ±ºå®šç›®æ¨™
        if (multiplier > 0) {
            targetSlotIndex = activeSlotIndices[Math.floor(Math.random() * activeSlotIndices.length)];
        } else {
            let all = Array.from({length: NUM_SLOTS}, (_, i) => i);
            let empty = all.filter(i => !activeSlotIndices.includes(i));
            targetSlotIndex = empty[Math.floor(Math.random() * empty.length)];
        }

        // ç™¼å°„çƒ
        ball.x = width / 2 + (Math.random()-0.5)*20; 
        ball.y = 20;
        ball.vx = (Math.random() - 0.5) * 2; 
        ball.vy = 0;
        ball.active = true;
    }

    function showResult() {
        const modal = document.getElementById("resultModal");
        const title = document.getElementById("resTitle");
        const val = document.getElementById("resVal");
        
        modal.style.display = "flex";
        if (pendingResult.win) {
            title.innerText = "ğŸ‰ ä¸­çå•¦!";
            title.style.color = "#00f260";
            val.innerText = "+" + pendingResult.payout + " CRO";
        } else {
            title.innerText = "ğŸ˜¢ æ²’ä¸­...";
            title.style.color = "#aaa";
            val.innerText = "å†æ¥å†å²";
        }
        updatePool();
    }

    function closeModal() {
        document.getElementById("resultModal").style.display = "none";
        document.getElementById("playBtn").disabled = false;
        document.getElementById("playBtn").innerText = "ğŸ”´ ç™¼å°„å½ˆç ";
    }

    initPhysics();
</script>

</body>
</html>

